<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>SQL Master - Dynamic Multi-Table</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; }
        .container { width: 95%; max-width: 1100px; margin: 0 auto; }
        .box { background: white; padding: 20px; margin-top: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #1a73e8; }
        .form-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        textarea, input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        .btn-primary { background-color: #1a73e8; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-secondary { background-color: #5f6368; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 5px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0 20px 0; background: white; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 10px; text-align: left; font-size: 13px; }
        th { background: #f8f9fa; color: #555; }
        pre { background: #282c34; color: #abb2bf; padding: 15px; border-radius: 8px; overflow-x: auto; line-height: 1.5; }
        .nav-controls { display: flex; gap: 10px; margin-top: 20px; }
        button { cursor: pointer; padding: 8px 15px; border-radius: 5px; border: 1px solid #ddd; }
        .jump-buttons button { margin: 2px; background: white; }
        .jump-buttons button.active { background: #1a73e8; color: white; border-color: #1a73e8; }
        .table-title { color: #d93025; font-weight: bold; margin-top: 15px; text-transform: uppercase; font-size: 14px; }
        .hidden { display: none; }
        .hint { font-size: 12px; color: #666; font-style: italic; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸ“š SQL Question Manager</h1>

    <div class="nav-controls">
        <button onclick="showSection('viewer')">View Questions</button>
        <button onclick="showSection('editor')" style="background-color: #34a853; color: white;">+ Add New Question</button>
        <button onclick="exportData()" style="background-color: #fbbc05;">Download Backup</button>
    </div>

    <div id="editorSection" class="box hidden">
        <h2>Add New SQL Scenario</h2>
        
        <div class="form-group">
            <label>Question Text</label>
            <textarea id="in_question" rows="2"></textarea>
        </div>

        <div class="form-group">
            <label>Datasets (JSON Format)</label>
            <div class="hint">Paste raw text below and click convert if you don't have JSON:</div>
            <textarea id="raw_text_input" rows="3" placeholder="id, name&#10;1, sai&#10;2, krishna"></textarea>
            <button class="btn-secondary" onclick="convertRawToJSON()">âš¡ Convert Raw Text to JSON</button>
            <textarea id="in_dataset" rows="6" style="margin-top:10px;" placeholder='Resulting JSON will appear here...'></textarea>
        </div>

        <div class="form-group">
            <label>Expected Output (JSON Array)</label>
            <textarea id="in_output" rows="3" placeholder='[{"id": 1, "status": "Pass"}]'></textarea>
        </div>

        <div class="form-group">
            <label>SQL Answer</label>
            <textarea id="in_answer" rows="5" style="font-family: monospace;"></textarea>
        </div>

        <button class="btn-primary" onclick="saveNewQuestion()">Save Question</button>
    </div>

    <div id="viewerSection">
        <div id="jumpButtons" class="jump-buttons box"></div>
        <div id="displayArea">
            <div class="box">
                <h3 id="qTitle">Question</h3>
                <p id="qText" style="white-space: pre-wrap;"></p>
            </div>
            <h3>Input Tables</h3>
            <div id="datasetBox" class="box"></div>
            <h3>Expected Output</h3>
            <div id="outputBox" class="box"></div>
            <h2>ðŸŸ¢ SQL Answer</h2>
            <div class="box"><pre id="answerBox"></pre></div>
        </div>
    </div>
</div>

<script>
let questions = JSON.parse(localStorage.getItem('sql_db')) || [];
let currentIndex = 0;

function convertRawToJSON() {
    const raw = document.getElementById('raw_text_input').value.trim();
    if (!raw) return alert("Please paste raw text first!");

    const lines = raw.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const result = [];

    for (let i = 1; i < lines.length; i++) {
        const obj = {};
        const currentLine = lines[i].split(',').map(v => v.trim());
        if (currentLine.length === headers.length) {
            headers.forEach((h, index) => {
                let val = currentLine[index];
                // Try to treat as number if possible
                obj[h] = isNaN(val) ? val : Number(val);
            });
            result.push(obj);
        }
    }
    document.getElementById('in_dataset').value = JSON.stringify(result, null, 2);
}

function showSection(type) {
    document.getElementById('editorSection').classList.toggle('hidden', type !== 'editor');
    document.getElementById('viewerSection').classList.toggle('hidden', type !== 'viewer');
}

function renderJumpButtons() {
    const container = document.getElementById('jumpButtons');
    container.innerHTML = '';
    questions.forEach((_, idx) => {
        const btn = document.createElement('button');
        btn.textContent = 'Q' + (idx + 1);
        btn.className = (idx === currentIndex) ? 'active' : '';
        btn.onclick = () => { currentIndex = idx; displayQuestion(); };
        container.appendChild(btn);
    });
}

function displayQuestion() {
    if (questions.length === 0) {
        document.getElementById('displayArea').innerHTML = "<p>No questions. Click '+ Add New Question' to start.</p>";
        return;
    }
    const q = questions[currentIndex];
    document.getElementById('qTitle').textContent = `Question ${currentIndex + 1}`;
    document.getElementById('qText').textContent = q.question;
    
    let datasetHtml = "";
    if (q.dataset && !Array.isArray(q.dataset) && typeof q.dataset === 'object') {
        for (let tableName in q.dataset) {
            datasetHtml += `<div class="table-title">Table: ${tableName}</div>` + renderTable(q.dataset[tableName]);
        }
    } else {
        datasetHtml = renderTable(q.dataset);
    }
    
    document.getElementById('datasetBox').innerHTML = datasetHtml;
    document.getElementById('outputBox').innerHTML = renderTable(q.output);
    document.getElementById('answerBox').textContent = q.answer;
    renderJumpButtons();
}

function renderTable(data) {
    if (!data || !Array.isArray(data) || data.length === 0) return "No data provided.";
    const headers = Object.keys(data[0]);
    let html = '<table><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
    data.forEach(row => {
        html += '<tr>' + headers.map(h => `<td>${row[h] !== null ? row[h] : ''}</td>`).join('') + '</tr>';
    });
    return html + '</tbody></table>';
}

function saveNewQuestion() {
    try {
        const newQ = {
            question: document.getElementById('in_question').value,
            dataset: JSON.parse(document.getElementById('in_dataset').value || "[]"),
            output: JSON.parse(document.getElementById('in_output').value || "[]"),
            answer: document.getElementById('in_answer').value
        };
        questions.push(newQ);
        localStorage.setItem('sql_db', JSON.stringify(questions));
        currentIndex = questions.length - 1;
        showSection('viewer');
        displayQuestion();
    } catch (e) {
        alert("JSON Error: Check that the dataset box contains valid JSON.");
    }
}

function exportData() {
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(questions, null, 4));
    const dlAnchor = document.createElement('a');
    dlAnchor.setAttribute("href", dataStr);
    dlAnchor.setAttribute("download", "sql_backup.json");
    dlAnchor.click();
}

displayQuestion();
</script>
</body>
</html>
