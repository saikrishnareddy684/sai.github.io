<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SSAS MCQ Exam – Batch + Resume + Timers + Persistence</title>
  <style>
    :root{--bg:#f4f4f4;--card:#fff;--accent:#007bff;--good:#28a745;--bad:#dc3545;--muted:#666}
    body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:20px;color:#222}
    .container{max-width:1000px;margin:auto;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
    h1{margin:0 0 12px;color:var(--accent)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
    .primary{background:var(--accent);color:#fff}
    .secondary{background:#6c757d;color:#fff}
    .warn{background:#ffc107}
    .danger{background:var(--bad);color:#fff}
    .menu{margin-bottom:12px}
    #questionBox{padding:12px;border-radius:8px;background:#fafafa;margin:12px 0}
    .progress{height:10px;background:#eee;border-radius:6px;overflow:hidden}
    .progress > div{height:100%;background:var(--accent);width:0%}
    .small{font-size:0.9rem;color:var(--muted)}
    .navNums{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .navNums button{width:36px;height:36px;border-radius:50%;background:#e9ecef;border:2px solid transparent}
    .navNums button.answered{background:var(--good);color:#fff}
    .navNums button.marked{outline:2px dashed #ff9800}
    .dark{background:#121214;color:#e6eef8}
    .dark #questionBox{background:#1a1a1f}
    .controls-left { display:flex; gap:8px; align-items:center; }
    /* menu extras */
    .batch-btn { min-width:140px; padding:10px 12px; border-radius:8px; font-weight:600; }
    .batch-wrap { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .reset-btn { margin-top:16px; display:inline-block; }
  </style>
</head>
<body>
<div class="container" id="app">
  <h1>SSAS MCQ Exam — Batch Mode</h1>

  <div id="menu" class="menu">
<div class="row small" style="margin-bottom:10px;">
  <strong>Filter by Difficulty:</strong>
  <button class="secondary" onclick="setLevelFilter('All')">All</button>
  <button class="secondary" onclick="setLevelFilter('Easy')">Easy</button>
  <button class="secondary" onclick="setLevelFilter('Medium')">Medium</button>
  <button class="secondary" onclick="setLevelFilter('Hard')">Hard</button>
</div>
</div>

  <div id="controls" style="display:none" class="row">
    <div class="small">Batch: <strong id="batchTitle"></strong></div>
    <div class="small">Global Time: <span id="globalTimer"></span></div>
    <div class="small">Question Time: <span id="questionTimer"></span></div>

    <div style="margin-left:auto" class="controls-left">
      <button id="homeBtn" class="secondary">Home</button>
      <button id="prevBatchBtn" class="secondary">Prev Batch</button>
      <button id="nextBatchBtn" class="secondary">Next Batch</button>
      <button id="shuffleToggle" class="secondary">Shuffle: ON</button>
      <button id="darkToggle" class="secondary">Dark</button>
      <button id="exportBtn" class="secondary">Export</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="importBtn" class="secondary">Import</button>
    </div>
  </div>

  <div id="exam" style="display:none">
    <div id="questionBox"></div>

    <div class="row">
      <button id="prevBtn" class="secondary">Previous</button>
      <button id="nextBtn" class="primary">Next</button>
      <button id="answerLaterBtn" class="warn">Answer Later (Mark)</button>
      <button id="pauseBtn" class="secondary">Pause</button>
      <button id="resumeBtn" class="primary" style="display:none">Resume</button>
      <button id="submitBtn" class="danger">Submit Batch</button>
    </div>

    <div style="margin-top:12px">
      <div class="progress"><div id="progBar"></div></div>
      <div class="row small" style="justify-content:space-between;margin-top:6px">
        <div id="progressText"></div>
        <div id="marksLegend" class="small"></div>
      </div>
      <div class="navNums" id="navNums"></div>
    </div>
  </div>

  <div id="result" style="margin-top:12px"></div>
</div>
 
<script>
/* ----------------- CONFIG ----------------- */
const QUESTIONS_PER_BATCH = 25;
const PER_QUESTION_SECONDS = 20;
const LS_KEY = 'mcq_exam_v2_state'; 
const COMPLETED_KEY = 'mcq_completed_batches';

/* ----------------- SAMPLE QUESTIONS (replace with full set later) ----------------- */
let originalQuestions = [

  {
    "q": "What does SSAS stand for?",
    "options": ["SQL Server Advanced Storage","SQL Server Analysis Services","SQL Server Analytical System","SQL Server Aggregation Service"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "SSAS is primarily used for which type of processing?",
    "options": ["OLTP","ETL","OLAP","CDC"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS object stores numerical data for analysis?",
    "options": ["Dimension","Measure","Hierarchy","Attribute"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which schema is most commonly used for SSAS modeling?",
    "options": ["Flat","Star","Network","XML"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which dimension answers the question 'When'?",
    "options": ["Customer","Product","Time","Geography"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "What is a fact table?",
    "options": ["Stores descriptive data","Stores aggregated data only","Stores measurable business data","Stores hierarchies"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS object defines how data is grouped?",
    "options": ["Measure","Dimension","Partition","Aggregation"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which key uniquely identifies a dimension record?",
    "options": ["Foreign key","Surrogate key","Natural key","Alternate key"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which language is used to query SSAS cubes?",
    "options": ["SQL","DAX","MDX","Python"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which tool is commonly used to develop SSAS cubes?",
    "options": ["SQL Server Management Studio","Visual Studio","Power BI Desktop","Azure Data Studio"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },

  {
    "q": "What is a measure group in SSAS?",
    "options": ["Collection of dimensions","Collection of related measures","A calculated column","A hierarchy"],
    "answer": 1,
    "time": 30,
    "level": "Medium"
  },
  {
    "q": "Why are attribute relationships important?",
    "options": ["Improve cube security","Improve performance","Reduce storage","Enable ETL"],
    "answer": 1,
    "time": 30,
    "level": "Medium"
  },
  {
    "q": "Which storage mode offers best query performance?",
    "options": ["ROLAP","HOLAP","MOLAP","DirectQuery"],
    "answer": 2,
    "time": 30,
    "level": "Medium"
  },
  {
    "q": "What is a role-playing dimension?",
    "options": ["Dimension used once","Dimension used in multiple roles","Calculated dimension","Degenerate dimension"],
    "answer": 1,
    "time": 30,
    "level": "Medium"
  },
  {
    "q": "What happens if attribute relationships are not defined?",
    "options": ["Cube fails","Slow queries","Wrong aggregations","Data loss"],
    "answer": 1,
    "time": 30,
    "level": "Medium"
  },
  {
    "q": "Which object allows incremental data loading?",
    "options": ["Perspective","Partition","Hierarchy","KPI"],
    "answer": 1,
    "time": 30,
    "level": "Medium"
  },
  {
    "q": "What is a degenerate dimension?",
    "options": ["Fact without key","Dimension without attributes","Fact attribute stored in fact table","Unused dimension"],
    "answer": 2,
    "time": 30,
    "level": "Medium"
  },
  {
    "q": "Which SSAS object limits user access?",
    "options": ["Partition","Perspective","Role","Hierarchy"],
    "answer": 2,
    "time": 30,
    "level": "Medium"
  },
  {
    "q": "What is a perspective in SSAS?",
    "options": ["Security layer","Subset of cube","Aggregation","Processing mode"],
    "answer": 1,
    "time": 30,
    "level": "Medium"
  },
  {
    "q": "Which operation rebuilds aggregations?",
    "options": ["Process Update","Process Clear","Process Full","Process Index"],
    "answer": 3,
    "time": 30,
    "level": "Medium"
  },

  {
    "q": "Which processing option deletes and reloads all data?",
    "options": ["Process Update","Process Full","Process Index","Process Clear"],
    "answer": 1,
    "time": 45,
    "level": "Hard"
  },
  {
    "q": "Which feature improves query speed by pre-calculating data?",
    "options": ["Partitions","Aggregations","Perspectives","KPIs"],
    "answer": 1,
    "time": 45,
    "level": "Hard"
  },
  {
    "q": "What is the main use of partitions?",
    "options": ["Security","Incremental processing","UI simplification","Hierarchy creation"],
    "answer": 1,
    "time": 45,
    "level": "Hard"
  },
  {
    "q": "Which SSAS mode stores data in relational tables?",
    "options": ["MOLAP","ROLAP","HOLAP","Tabular"],
    "answer": 1,
    "time": 45,
    "level": "Hard"
  },
  {
    "q": "Which MDX function retrieves members?",
    "options": ["SUM","FILTER","MEMBERS","CALCULATE"],
    "answer": 2,
    "time": 45,
    "level": "Hard"
  },
  {
    "q": "Which scenario best suits HOLAP?",
    "options": ["Small cubes","Large facts with summaries","Real-time OLTP","Disconnected analysis"],
    "answer": 1,
    "time": 45,
    "level": "Hard"
  },
  {
    "q": "What happens during Process Update of a dimension?",
    "options": ["Full reload","Only changed data","Only indexes","Only facts"],
    "answer": 1,
    "time": 45,
    "level": "Hard"
  },
  {
    "q": "Which feature hides sensitive measures?",
    "options": ["Partition","Perspective","Role","Aggregation"],
    "answer": 2,
    "time": 45,
    "level": "Hard"
  },
  {
    "q": "Which attribute controls granularity of fact data?",
    "options": ["Measure","Dimension key","Hierarchy","Aggregation"],
    "answer": 1,
    "time": 45,
    "level": "Hard"
  },
  {
    "q": "Which SSAS object improves scalability?",
    "options": ["Hierarchy","Partition","Perspective","Attribute"],
    "answer": 1,
    "time": 45,
    "level": "Hard"
  }

,
  {
    "q": "What does SSAS stand for?",
    "options": ["SQL Server Automation Services","SQL Server Analysis Services","Structured Storage Analysis System","SQL Server Advanced Services"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "SSAS is primarily designed for which type of workload?",
    "options": ["Transaction processing","Real-time messaging","Analytical processing","File storage"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "SSAS focuses on analysis rather than which of the following?",
    "options": ["Reporting","Visualization","Transaction processing","Aggregation"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which operation is an example of simple analysis in SSAS?",
    "options": ["INSERT","DELETE","SUM","MERGE"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which of the following is an example of a complex calculation in SSAS?",
    "options": ["COUNT","SUM","YTD","SELECT"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "What does 'analysis' in SSAS mainly refer to?",
    "options": ["Storing raw data","Running transactions","Applying business calculations","Backing up databases"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "What is an SSAS Cube?",
    "options": ["A relational table","A pre-aggregated analytical structure","A flat file","A reporting dashboard"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Why are cubes faster than querying raw tables?",
    "options": ["They use indexes only","They store data in CSV format","They pre-calculate aggregations","They avoid joins completely"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which of the following is NOT a core component of an SSAS cube?",
    "options": ["Measures","Dimensions","Indexes","Measure Groups"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Measures in SSAS represent what kind of data?",
    "options": ["Text descriptions","Numeric values","Image data","Configuration settings"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which of the following is an example of a measure?",
    "options": ["Customer Name","Product Category","Sales Amount","Region"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Measures are typically sourced from which type of table?",
    "options": ["Dimension table","Fact table","Lookup table","Metadata table"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "What is the purpose of dimensions in SSAS?",
    "options": ["Store numerical values","Perform calculations","Describe and slice data","Execute queries"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which of the following is a typical dimension?",
    "options": ["Sales Amount","Transaction Count","Customer","Balance"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Time, Customer, and Product are examples of what in SSAS?",
    "options": ["Measures","Facts","Dimensions","Indexes"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "What is a Measure Group in SSAS?",
    "options": ["A group of dimensions","A collection of reports","A logical grouping of measures","A security role"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Each measure group in SSAS is usually based on what?",
    "options": ["A dimension table","A fact table","A view only","An index"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "At which stage does pre-calculation happen in SSAS?",
    "options": ["Data loading","Cube processing","Query execution","Report rendering"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which of the following tools can query an SSAS cube?",
    "options": ["Power BI","Excel","MDX/DAX","All of the above"],
    "answer": 3,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "What is one major benefit of SSAS?",
    "options": ["Real-time transaction handling","Very fast analytical queries","File compression","Application hosting"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "SSAS helps maintain which of the following?",
    "options": ["Multiple versions of truth","Centralized business logic","Unstructured data","Temporary storage"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS model uses cubes and MDX?",
    "options": ["Tabular Model","Relational Model","Multidimensional Model","Graph Model"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS model uses tables and DAX?",
    "options": ["Multidimensional Model","Tabular Model","Flat Model","Index Model"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS model is generally faster to develop?",
    "options": ["Multidimensional","Tabular","Hierarchical","Normalized"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "In a banking scenario, SSAS is mainly used to analyze what?",
    "options": ["ATM transactions in real time","Customer login activity","Balances, exposure, and risk metrics","Email communications"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which statement best describes SSAS in one line?",
    "options": [
      "A transactional database engine",
      "A Microsoft tool for ETL processing",
      "A Microsoft analytical engine for fast reporting",
      "A file-based reporting system"
    ],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  }

,


  {
    "q": "SSAS is mainly used for which type of processing?",
    "options": ["OLTP","OLAP","ETL","Streaming"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "SSAS is part of which Microsoft product suite?",
    "options": ["Microsoft Azure","Microsoft Power BI","Microsoft SQL Server","Microsoft Office"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Besides OLAP, SSAS also supports which capability?",
    "options": ["Web hosting","Data mining","File storage","Message queuing"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "How many operational modes does SSAS have?",
    "options": ["One","Two","Three","Four"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS mode is considered more traditional?",
    "options": ["Tabular Mode","Multidimensional Mode","Relational Mode","Hybrid Mode"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS mode uses cubes, dimensions, and measures?",
    "options": ["Tabular Mode","Multidimensional Mode","Flat Mode","Streaming Mode"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS mode is known to have a steep learning curve?",
    "options": ["Tabular Mode","Multidimensional Mode","Power BI Mode","Import Mode"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS mode is more modern and widely adopted today?",
    "options": ["Multidimensional Mode","Tabular Mode","OLTP Mode","Normalized Mode"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "The Tabular model in SSAS is conceptually similar to which tool?",
    "options": ["SSRS","Power BI","Azure Data Factory","SQL Agent"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which engine powers the SSAS Tabular model?",
    "options": ["VertiPaq","xVelocity in-memory engine","PolyBase","InnoDB"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Why is the Tabular model easier for Power BI developers?",
    "options": ["Uses MDX","Uses tables and relationships","Requires XML coding","Uses stored procedures"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "What is a Data Source in SSAS?",
    "options": ["A cube","A report","The origin of the data","A calculation layer"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which system is most commonly used as a data source for SSAS?",
    "options": ["MongoDB","SQL Server","Excel only","Flat files only"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "What is a Data Source View (DSV) in SSAS?",
    "options": [
      "A physical copy of data",
      "A reporting dashboard",
      "A logical representation of data",
      "A security layer"
    ],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which SSAS object provides descriptive context to measures?",
    "options": ["Fact table","Dimension","Index","Partition"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "What does the final Cube or Model represent in SSAS?",
    "options": [
      "Raw transactional data",
      "Final analytical structure",
      "Backup storage",
      "ETL pipeline"
    ],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which formula language is used in SSAS Tabular models?",
    "options": ["SQL","MDX","DAX","Python"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "DAX stands for:",
    "options": [
      "Data Analysis Expressions",
      "Dynamic Aggregation Syntax",
      "Data Access Extension",
      "Distributed Analysis XML"
    ],
    "answer": 0,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which analytical action allows users to navigate from summary to detailed data?",
    "options": ["Filtering","Sorting","Drill down","Indexing"],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Slice and dice operations in SSAS are mainly enabled by which objects?",
    "options": ["Measures","Dimensions","Indexes","Partitions"],
    "answer": 1,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Which tools are most commonly used to connect to SSAS models?",
    "options": ["Excel and Power BI","Notepad and Excel","SSMS only","Visual Studio only"],
    "answer": 0,
    "time": 20,
    "level": "Easy"
  },
  {
    "q": "Why do organizations use SSAS for large datasets?",
    "options": [
      "To replace OLTP systems",
      "To simplify transactions",
      "To analyze massive data efficiently",
      "To store unstructured data"
    ],
    "answer": 2,
    "time": 20,
    "level": "Easy"
  }
,


  {
    "q": "What does the error 'A connection cannot be made to redirector' usually indicate in SSAS?",
    "options": [
      "Incorrect DAX syntax",
      "SQL Browser service is not running",
      "Cube processing failure",
      "Invalid dimension key"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which service must be running to resolve redirector connection issues in SSAS?",
    "options": [
      "SQL Server Agent",
      "SQL Server Integration Services",
      "SQL Server Browser",
      "SQL Server Reporting Services"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which tool is commonly used to verify whether SSAS services are running?",
    "options": [
      "Task Manager",
      "SQL Server Configuration Manager",
      "Event Viewer",
      "Power BI Desktop"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "In a Star Schema, how are dimension tables connected to the fact table?",
    "options": [
      "Indirectly through bridge tables",
      "Directly to the fact table",
      "Through other dimensions",
      "Via stored procedures"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which schema design is simpler and easier to understand?",
    "options": [
      "Snowflake Schema",
      "Galaxy Schema",
      "Star Schema",
      "Normalized Schema"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Why does a Star Schema generally provide better query performance?",
    "options": [
      "Uses indexes only",
      "Requires fewer joins",
      "Uses temporary tables",
      "Avoids dimensions"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which schema is more commonly used in large enterprise data warehouses?",
    "options": [
      "Star Schema",
      "Snowflake Schema",
      "Flat Schema",
      "Document Schema"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "In a Snowflake Schema, dimension tables are:",
    "options": [
      "Fully denormalized",
      "Normalized into sub-dimensions",
      "Stored in fact tables",
      "Replaced by views"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What is a key drawback of the Snowflake Schema?",
    "options": [
      "Consumes more storage",
      "Hard to implement security",
      "Slower queries due to more joins",
      "Cannot support hierarchies"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "How can a Star Schema be converted into a Snowflake Schema?",
    "options": [
      "By denormalizing dimension tables",
      "By normalizing dimension tables",
      "By removing dimensions",
      "By merging fact tables"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "In Adventure Works DW, which table connects directly to Fact Internet Sales in a Star Schema?",
    "options": [
      "Dim Product Subcategory",
      "Dim Product",
      "Dim Product Category",
      "Dim Sales Territory"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What is a conformed dimension?",
    "options": [
      "A dimension used in only one fact table",
      "A dimension shared across multiple fact tables",
      "A calculated dimension",
      "A temporary dimension"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which feature is mandatory for a conformed dimension?",
    "options": [
      "Different attributes per fact",
      "Same structure and meaning",
      "Separate keys for each fact",
      "Different granularity"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Why are conformed dimensions important in enterprise reporting?",
    "options": [
      "Improve ETL speed",
      "Enable cross-fact analysis",
      "Reduce cube size",
      "Avoid dimension processing"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which dimension is most commonly conformed across fact tables?",
    "options": [
      "Employee",
      "Time",
      "Promotion",
      "Transaction"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "In banking, which dimension is often conformed across Loan, Deposit, and Risk facts?",
    "options": [
      "Branch",
      "Customer",
      "Currency",
      "Account Type"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What is the primary role of a dimension in a data warehouse?",
    "options": [
      "Store transactions",
      "Provide descriptive context",
      "Perform aggregations",
      "Manage security"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which key relationship exists between dimension and fact tables?",
    "options": [
      "Fact primary key to dimension primary key",
      "Dimension primary key to fact foreign key",
      "Fact foreign key to fact primary key",
      "Dimension foreign key to dimension foreign key"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What do hierarchies in dimensions primarily support?",
    "options": [
      "Index creation",
      "Drill-down and roll-up analysis",
      "Data loading",
      "Security enforcement"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which Time hierarchy is correctly ordered?",
    "options": [
      "Day → Month → Year",
      "Year → Month → Quarter → Day",
      "Year → Quarter → Month → Day",
      "Month → Day → Year"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Why are hierarchies recommended in SSAS dimensions?",
    "options": [
      "They reduce data size",
      "They improve processing and query performance",
      "They eliminate fact tables",
      "They replace measures"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Can dimensions contain numeric attributes?",
    "options": [
      "No, dimensions are strictly text-based",
      "Yes, but not used for aggregation",
      "Yes, and they must be aggregated",
      "Only in fact tables"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  }
,


  {
    "q": "What is a Data Mart?",
    "options": [
      "A logical abstraction layer",
      "A subject-oriented physical subset of a data warehouse",
      "A reporting visualization tool",
      "A security layer"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which of the following best describes a Semantic Layer?",
    "options": [
      "Physical data storage",
      "ETL processing layer",
      "Business abstraction layer",
      "Backup storage"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which layer actually stores data?",
    "options": ["Semantic Layer","Data Mart","Power BI Report","SSAS Model"],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Business logic such as KPIs and calculations mainly belongs to which layer?",
    "options": ["Data Mart","ETL Layer","Semantic Layer","Source System"],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which tools are commonly used to build a Semantic Layer?",
    "options": ["SQL Server and ETL","SSAS and Power BI","Excel only","File systems"],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Who primarily consumes the Semantic Layer?",
    "options": ["ETL developers","DBAs","Business users","System admins"],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which statement best differentiates Data Mart and Semantic Layer?",
    "options": [
      "Data Mart models data, Semantic Layer stores it",
      "Data Mart stores data, Semantic Layer models it",
      "Both store physical data",
      "Both are purely logical"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  }

,

  {
    "q": "What is the primary purpose of SQL?",
    "options": [
      "Define business KPIs",
      "Apply row-level security",
      "Retrieve and prepare data",
      "Create hierarchies"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What is the primary purpose of DAX?",
    "options": [
      "Data extraction",
      "Data cleansing",
      "Business calculations",
      "Table joins"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Where is SQL executed?",
    "options": [
      "Semantic layer",
      "Power BI Service",
      "Database engine",
      "SSAS processing engine"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Where is DAX executed?",
    "options": [
      "Database engine",
      "ETL layer",
      "Semantic layer",
      "Source system"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which context does SQL primarily operate on?",
    "options": [
      "Filter context",
      "Evaluation context",
      "Row-based context",
      "Time context"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which context is fundamental to DAX calculations?",
    "options": [
      "Row context only",
      "Filter context",
      "Transaction context",
      "Cursor context"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which task should be handled using DAX instead of SQL?",
    "options": [
      "Joining tables",
      "Data cleansing",
      "Time intelligence calculations",
      "Filtering source rows"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which statement best summarizes SQL vs DAX?",
    "options": [
      "SQL defines business rules, DAX fetches data",
      "SQL fetches data, DAX defines business logic",
      "Both serve the same purpose",
      "DAX replaces SQL completely"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  }
,

  {
    "q": "What is the main purpose of Row-Level Security (RLS)?",
    "options": [
      "Restrict access to reports",
      "Restrict access to rows of data",
      "Restrict access to databases",
      "Restrict access to servers"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "RLS restricts data visibility based on what?",
    "options": [
      "Report design",
      "User identity or role",
      "Database size",
      "Processing mode"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "When is RLS evaluated in SSAS or Power BI?",
    "options": [
      "During data load",
      "During cube processing",
      "At query time",
      "During model deployment"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which type of RLS applies the same filter to all users in a role?",
    "options": [
      "Dynamic RLS",
      "Static RLS",
      "Hierarchical RLS",
      "Implicit RLS"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which type of RLS uses the logged-in user’s identity?",
    "options": [
      "Static RLS",
      "Manual RLS",
      "Dynamic RLS",
      "Object RLS"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which DAX function is commonly used in Dynamic RLS?",
    "options": [
      "SUM()",
      "CALCULATE()",
      "USERPRINCIPALNAME()",
      "RELATED()"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Where is RLS defined in Power BI?",
    "options": [
      "Power Query Editor",
      "Manage Roles",
      "Report View",
      "Dataset Settings"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which security model is used for RLS in SSAS Multidimensional?",
    "options": [
      "DAX roles",
      "MDX-based roles and dimension security",
      "Power BI roles",
      "SQL GRANT statements"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What does Object-Level Security (OLS) restrict?",
    "options": [
      "Rows of data",
      "Measures only",
      "Columns or tables",
      "Users only"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which best practice improves RLS scalability and performance?",
    "options": [
      "Hardcoding user names",
      "Complex nested DAX",
      "Using mapping tables",
      "Applying RLS during ETL"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Does RLS affect aggregations in reports?",
    "options": [
      "No, aggregations ignore RLS",
      "Yes, aggregations respect RLS filters",
      "Only in SQL Server",
      "Only during processing"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Can RLS be bypassed by regular users?",
    "options": [
      "Yes, using filters",
      "Yes, using DAX",
      "No, unless the user is an admin",
      "Yes, using SQL"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  }
,

  
  {
    "q": "Why is SSAS commonly used along with Power BI in enterprise setups?",
    "options": [
      "For ETL processing",
      "To replace Power BI visuals",
      "To provide a centralized semantic layer",
      "To store raw transactional data"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What is the main architectural role of SSAS when used with Power BI?",
    "options": [
      "Visualization layer",
      "Data ingestion layer",
      "Enterprise semantic layer",
      "Backup storage"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "How does SSAS help avoid duplication across Power BI reports?",
    "options": [
      "By copying datasets",
      "By using DirectQuery only",
      "By sharing a single centralized model",
      "By disabling local models"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which engine provides high performance in SSAS Tabular models?",
    "options": [
      "SQL Engine",
      "VertiPaq (xVelocity) in-memory engine",
      "PolyBase",
      "Spark engine"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Compared to DirectQuery, SSAS typically provides:",
    "options": [
      "Slower performance",
      "Same performance",
      "Faster query performance",
      "No caching support"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which reporting tools can reuse the same SSAS model?",
    "options": [
      "Only Power BI",
      "Only Excel",
      "Power BI, Excel, and Paginated Reports",
      "Only SSMS"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which enterprise security features are supported by SSAS?",
    "options": [
      "File encryption only",
      "Row-Level Security and Object-Level Security",
      "Network firewall rules",
      "Disk-level security"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Why is SSAS preferred for very large enterprise models?",
    "options": [
      "Power BI Desktop has no limits",
      "SSAS handles larger models more efficiently",
      "SSAS avoids DAX",
      "SSAS stores raw data"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "In a banking architecture, which flow is most common?",
    "options": [
      "Power BI → SSAS → Snowflake",
      "Snowflake → SSAS → Power BI",
      "SSAS → Snowflake → Power BI",
      "Excel → Power BI → SSAS"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which statement best summarizes SSAS vs Power BI roles?",
    "options": [
      "Both are visualization tools",
      "Power BI is the semantic layer",
      "SSAS governs data, Power BI visualizes it",
      "SSAS replaces Power BI"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  }
,


  {
    "q": "What is a normal (non-conformed) dimension typically used for?",
    "options": [
      "Multiple fact tables",
      "Single fact table or system",
      "Enterprise-wide reporting",
      "Cross-functional analysis"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What makes a dimension a conformed dimension?",
    "options": [
      "It contains numeric values",
      "It is normalized",
      "It is shared across multiple fact tables",
      "It exists only in one data mart"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which characteristic must be identical in a conformed dimension?",
    "options": [
      "Table name only",
      "Business meaning and structure",
      "Row count only",
      "Index type"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What problem occurs when customer dimensions differ across systems?",
    "options": [
      "Improved flexibility",
      "Faster queries",
      "Inconsistent reporting",
      "Better normalization"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Why are surrogate keys important in conformed dimensions?",
    "options": [
      "They reduce storage",
      "They enforce same keys across facts",
      "They replace primary keys",
      "They avoid joins"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which analysis becomes possible with conformed dimensions?",
    "options": [
      "Single-report analysis",
      "Cross-fact and cross-domain analysis",
      "Row-level security",
      "ETL validation"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which dimension is most commonly implemented as conformed?",
    "options": [
      "Promotion",
      "Employee",
      "Time",
      "Transaction"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  }
,



  {
    "q": "What does KPI stand for?",
    "options": [
      "Key Process Indicator",
      "Key Performance Indicator",
      "Known Performance Index",
      "Key Prediction Indicator"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "What is the primary purpose of a KPI?",
    "options": [
      "Store raw data",
      "Measure performance against a target",
      "Clean data",
      "Control ETL workflows"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which component is mandatory for a KPI?",
    "options": [
      "Hierarchy",
      "Target",
      "Filter",
      "Relationship"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which of the following is NOT a KPI component?",
    "options": [
      "Actual value",
      "Target",
      "Status",
      "Foreign key"
    ],
    "answer": 3,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "From what object are KPIs created in SSAS Tabular?",
    "options": [
      "Columns",
      "Tables",
      "Measures",
      "Relationships"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which value typically represents a 'Green' KPI status?",
    "options": [
      "-1",
      "0",
      "1",
      "NULL"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which SSAS model uses MDX expressions for KPIs?",
    "options": [
      "Tabular",
      "Relational",
      "Multidimensional",
      "Flat model"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "How does a KPI differ from a normal measure?",
    "options": [
      "KPIs do not show values",
      "KPIs include targets and status indicators",
      "Measures require DAX, KPIs do not",
      "Measures are visual-only"
    ],
    "answer": 1,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Where are KPIs typically defined?",
    "options": [
      "ETL layer",
      "Source system",
      "Semantic layer",
      "Visualization layer"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  },
  {
    "q": "Which banking KPI measures asset quality?",
    "options": [
      "Loan Approval TAT",
      "Revenue vs Target",
      "NPA Ratio",
      "Credit Limit"
    ],
    "answer": 2,
    "time": 25,
    "level": "Easy"
  }


  
];

/* ----------------- STATE ----------------- */
let questions = [];
let userAnswers = []; // integer | null
let questionRemain = []; // seconds left per question
let marked = []; // boolean mark for review
let batchIndex = 0;
let currentIndex = 0;
let globalSeconds = 0;
let paused = false;
let shuffleEnabled = true;
let darkMode = false;
let globalTimerId = null, questionTimerId = null;

// completed batches stored persistently
let completedBatches = JSON.parse(localStorage.getItem(COMPLETED_KEY) || "[]");

/* ----------------- HELPERS ----------------- */
function saveState(){
  const payload = { originalQuestions, questions, userAnswers, questionRemain, marked, batchIndex, currentIndex, globalSeconds, paused, shuffleEnabled, darkMode };
  localStorage.setItem(LS_KEY, JSON.stringify(payload));
}
function loadState(){
  try{ const s = localStorage.getItem(LS_KEY); return s? JSON.parse(s): null; }catch(e){return null}
}
function clearSavedState(){ localStorage.removeItem(LS_KEY); }

function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }}
function formatTime(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m}:${String(s).padStart(2,'0')}`; }
function inProgress(){ return questions && questions.length && userAnswers.some(a=>a!==null); }

/* ----------------- BATCH MENU ----------------- */
function renderBatchMenu(){
  const menu = document.getElementById('menu');
  menu.innerHTML = '';
  const total = Math.max(1, Math.ceil(originalQuestions.length / QUESTIONS_PER_BATCH));
  const h = document.createElement('div'); h.innerHTML = `<strong>Select Batch</strong>`; menu.appendChild(h);

  const btnWrap = document.createElement('div');
  btnWrap.className = 'batch-wrap';

  for(let b=0;b<total;b++){
    const btn = document.createElement('button');
    btn.className = 'batch-btn';
    btn.style.border = '0';
    // show completed status
    if (completedBatches.includes(b)){
      btn.style.background = 'var(--good)';
      btn.style.color = '#fff';
      btn.textContent = `Batch ${b+1} ✓ Completed`;
    } else {
      btn.classList.add('primary');
      btn.textContent = `Start Batch ${b+1}`;
      btn.style.color = '#fff';
    }
    btn.onclick = ()=> startBatchWithCheck(b);
    btnWrap.appendChild(btn);
  }
  menu.appendChild(btnWrap);

  // Resume button if saved
  const st = loadState();
  if(st && st.questions && st.questions.length){
    const br = document.createElement('div'); br.style.marginTop='10px';
    const r = document.createElement('button'); r.className='warn'; r.textContent='Resume Last Attempt'; r.onclick=resumeExam;
    br.appendChild(r);
    menu.appendChild(br);
  }

  // Reset All Batches button
  const resetWrap = document.createElement('div');
  resetWrap.style.marginTop = '16px';
  const resetBtn = document.createElement('button');
  resetBtn.className = 'reset-btn';
  resetBtn.style.background = 'var(--bad)';
  resetBtn.style.color = '#fff';
  resetBtn.style.padding = '10px 14px';
  resetBtn.style.borderRadius = '8px';
  resetBtn.textContent = 'Reset All Batches';
  resetBtn.onclick = resetAllBatches;
  resetWrap.appendChild(resetBtn);
  menu.appendChild(resetWrap);

  // Small note
  const note = document.createElement('div'); note.className='small'; note.style.marginTop='10px';
  note.textContent = 'You can submit any batch anytime and switch batches freely. Progress is saved locally. Use Reset to clear completions.';
  menu.appendChild(note);
}

// helper: confirm before starting new batch if current in-progress
function startBatchWithCheck(targetBatch){
  if(inProgress()){
    const ok = confirm('You have in-progress answers in the current batch. Starting another batch will discard the current in-memory progress (saved attempts remain). Proceed?');
    if(!ok) return;
  }
  startBatch(targetBatch);
}

/* ----------------- START / RESUME ----------------- */
function startBatch(b){
  batchIndex = b;
  const start = b * QUESTIONS_PER_BATCH;
  const end = Math.min(start + QUESTIONS_PER_BATCH, originalQuestions.length);
  questions = JSON.parse(JSON.stringify(originalQuestions.slice(start, end)));
  if(shuffleEnabled) shuffleQuestionsAndOptions();
  userAnswers = new Array(questions.length).fill(null);
  questionRemain = new Array(questions.length).fill(PER_QUESTION_SECONDS);
  marked = new Array(questions.length).fill(false);
  currentIndex = 0;
  globalSeconds = questions.length * PER_QUESTION_SECONDS;
  paused = false;
  saveState();
  showExam();
}

function resumeExam(){
  const st = loadState();
  if(!st) return alert('No saved attempt');
  // restore
  originalQuestions = st.originalQuestions || originalQuestions;
  questions = st.questions || [];
  userAnswers = st.userAnswers || new Array(questions.length).fill(null);
  questionRemain = st.questionRemain || new Array(questions.length).fill(PER_QUESTION_SECONDS);
  marked = st.marked || new Array(questions.length).fill(false);
  batchIndex = st.batchIndex || 0;
  currentIndex = st.currentIndex || 0;
  globalSeconds = st.globalSeconds || (questions.length * PER_QUESTION_SECONDS);
  paused = !!st.paused;
  shuffleEnabled = typeof st.shuffleEnabled === 'boolean' ? st.shuffleEnabled : shuffleEnabled;
  darkMode = !!st.darkMode;
  applyUISettings();
  showExam();
}

function shuffleQuestionsAndOptions(){
  shuffleArray(questions);
  questions.forEach(q=>{
    const correctText = q.options[q.answer];
    shuffleArray(q.options);
    q.answer = q.options.indexOf(correctText);
  });
}

/* ----------------- RENDER EXAM ----------------- */
function showExam(){
  document.getElementById('menu').style.display = 'none';
  document.getElementById('controls').style.display = 'flex';
  document.getElementById('exam').style.display = 'block';
  document.getElementById('result').innerHTML = '';
  document.getElementById('batchTitle').textContent = `${batchIndex+1}`;
  applyUISettings();
  renderQuestion();
  renderNavNums();
  updateProgress();
  updateTimersDisplay();
  // ensure timers are running according to paused state
  clearInterval(globalTimerId); clearInterval(questionTimerId);
  if(!paused){ startGlobalTimer(); startQuestionTimer(); }
  // show/hide prev/next batch buttons appropriately
  updateBatchNavButtons();
}

function applyUISettings(){
  document.getElementById('shuffleToggle').textContent = `Shuffle: ${shuffleEnabled? 'ON':'OFF'}`;
  document.getElementById('darkToggle').textContent = darkMode? 'Light':'Dark';
  document.body.classList.toggle('dark', darkMode);
}

function renderQuestion(){
  if(!questions || questions.length === 0){
    document.getElementById('questionBox').innerHTML = '<em>No questions in this batch.</em>';
    return;
  }
  const q = questions[currentIndex];
  let html = `<div style='display:flex;justify-content:space-between;align-items:center'><div><strong>Q${currentIndex+1}.</strong> ${escapeHtml(q.q)}</div><div class='small'>Marked: <strong>${marked[currentIndex]? 'Yes':'No'}</strong></div></div><hr>`;
  q.options.forEach((opt,i)=>{
    const checked = (userAnswers[currentIndex]===i)? 'checked': '';
    html += `<label style='display:block;margin:8px 0;padding:8px;border-radius:6px;border:1px solid #eee;cursor:pointer'><input type='radio' name='opt' value='${i}' ${checked}> ${escapeHtml(opt)}</label>`;
  });
  document.getElementById('questionBox').innerHTML = html;
  document.querySelectorAll("input[name='opt']").forEach(el=>el.onchange = ()=>{
    userAnswers[currentIndex] = parseInt(el.value);
    saveState();
    renderNavNums();
    updateProgress();
  });
}

function renderNavNums(){
  const wrap = document.getElementById('navNums'); wrap.innerHTML = '';
  if(!questions) return;
  questions.forEach((q,i)=>{
    const b = document.createElement('button');
    b.textContent = i+1;
    b.style.minWidth = '36px';
    b.style.minHeight = '36px';
    if(userAnswers[i] !== null) b.classList.add('answered');
    if(marked[i]) b.classList.add('marked');
    if(i===currentIndex) b.style.boxShadow='0 0 0 4px rgba(0,123,255,0.12)';
    b.onclick = ()=>{ saveState(); currentIndex = i; renderQuestion(); startQuestionTimer(); updateTimersDisplay(); renderNavNums(); };
    wrap.appendChild(b);
  });
}

function updateProgress(){
  const answered = userAnswers.filter(x=>x!==null).length;
  const total = questions.length;
  const pct = total ? Math.round((answered/total)*100) : 0;
  document.getElementById('progBar').style.width = pct+'%';
  document.getElementById('progressText').textContent = `Answered ${answered} / ${total} (${pct}%)`;
  document.getElementById('marksLegend').innerHTML = `<span style='color:var(--good)'>Answered</span> &nbsp; <span style='border:2px dashed #ff9800;padding:2px;border-radius:4px'>Marked</span>`;
}

/* ----------------- TIMERS ----------------- */
function startGlobalTimer(){ clearInterval(globalTimerId); globalTimerId = setInterval(()=>{
  if(paused) return;
  globalSeconds--;
  if(globalSeconds <= 0){ globalSeconds = 0; submitBatch(); }
  saveState(); updateTimersDisplay();
}, 1000); }

function startQuestionTimer(){ clearInterval(questionTimerId); questionTimerId = setInterval(()=>{
  if(paused) return;
  if(!questionRemain[currentIndex] && questionRemain[currentIndex] !== 0) questionRemain[currentIndex] = PER_QUESTION_SECONDS;
  questionRemain[currentIndex] = (questionRemain[currentIndex] || PER_QUESTION_SECONDS) - 1;
  if(questionRemain[currentIndex] <= 0){ questionRemain[currentIndex] = 0; goNext(); }
  saveState(); updateTimersDisplay();
}, 1000); }

function updateTimersDisplay(){
  document.getElementById('globalTimer').textContent = formatTime(globalSeconds || 0);
  document.getElementById('questionTimer').textContent = (questionRemain[currentIndex] !== undefined ? questionRemain[currentIndex] : PER_QUESTION_SECONDS);
}

/* ----------------- NAVIGATION ----------------- */
function goNext(){
  if(!questions || questions.length===0) return;
  if(currentIndex < questions.length - 1){
    currentIndex++;
    renderQuestion(); renderNavNums(); startQuestionTimer(); saveState();
  } else {
    // at end — don't force submit automatically; show a message then let user decide
    const ok = confirm('You are at the last question. Do you want to submit this batch now?');
    if(ok) submitBatch();
  }
}
function goPrev(){
  if(!questions || questions.length===0) return;
  if(currentIndex > 0){
    currentIndex--;
    renderQuestion(); renderNavNums(); startQuestionTimer(); saveState();
  }
}

document.getElementById('nextBtn').onclick = ()=>{ saveState(); goNext(); };
document.getElementById('prevBtn').onclick = ()=>{ saveState(); goPrev(); };

document.getElementById('answerLaterBtn').onclick = ()=>{ if(!questions || !questions.length) return; marked[currentIndex] = true; saveState(); renderNavNums(); goNext(); };

document.getElementById('pauseBtn').onclick = ()=>{ paused = true; saveState(); document.getElementById('pauseBtn').style.display='none'; document.getElementById('resumeBtn').style.display='inline-block'; };
document.getElementById('resumeBtn').onclick = ()=>{ paused = false; saveState(); document.getElementById('pauseBtn').style.display='inline-block'; document.getElementById('resumeBtn').style.display='none'; startGlobalTimer(); startQuestionTimer(); };

/* ----------------- BATCH NAV BUTTONS & HOME ----------------- */
document.getElementById('homeBtn').onclick = ()=>{ // go back to menu (keeps saved state)
  clearInterval(globalTimerId); clearInterval(questionTimerId);
  document.getElementById('exam').style.display = 'none';
  document.getElementById('controls').style.display = 'none';
  document.getElementById('menu').style.display = 'block';
  document.getElementById('result').innerHTML = '';
  renderBatchMenu();
};

document.getElementById('nextBatchBtn').onclick = ()=>{ const total = Math.max(1, Math.ceil(originalQuestions.length / QUESTIONS_PER_BATCH)); if(batchIndex+1 >= total){ alert('No next batch'); return; } startBatchWithCheck(batchIndex+1); };
document.getElementById('prevBatchBtn').onclick = ()=>{ if(batchIndex-1 < 0){ alert('No previous batch'); return; } startBatchWithCheck(batchIndex-1); };

/* ----------------- SUBMIT & REVIEW ----------------- */
document.getElementById('submitBtn').onclick = ()=>{ // allow submit at any time
  const confirmNow = confirm('Submit this batch now? You will see the result and saved attempt will be cleared.');
  if(confirmNow) submitBatch();
};

function submitBatch(){
  clearInterval(globalTimerId); clearInterval(questionTimerId);
  let correct = 0;
  const details = (questions || []).map((q,i)=>{
    const ua = userAnswers[i];
    const isCorrect = (ua !== null && ua === q.answer);
    if(isCorrect) correct++;
    return { q: q.q, options: q.options, ua, correctIndex: q.answer, isCorrect };
  });

  const total = questions.length || 0;
  const pct = total ? ((correct/total)*100).toFixed(2) : '0.00';

  // Mark current batch as completed (persist this)
  if (!completedBatches.includes(batchIndex)) {
    completedBatches.push(batchIndex);
    localStorage.setItem(COMPLETED_KEY, JSON.stringify(completedBatches));
  }

  // clear saved state for this attempt (but keep completed list)
  clearSavedState();

  document.getElementById('exam').style.display = 'none';
  document.getElementById('controls').style.display = 'none';
  document.getElementById('result').innerHTML = `
    <h2>Batch ${batchIndex+1} Result</h2>
    <p><strong>Score:</strong> ${correct} / ${total} (${pct}%)</p>
    <div style="margin-top:12px">
      <button id='viewDetail' class='primary'>View Detailed Review</button>
      <button id='backMenu' class='secondary'>Back to Menu</button>
      <button id='startNext' class='secondary'>Start Next Batch</button>
    </div>
  `;

  document.getElementById('viewDetail').onclick = ()=> showDetailedReview(details);
  document.getElementById('backMenu').onclick = ()=> { location.reload(); }; // simple reload to restore initial UI
  document.getElementById('startNext').onclick = ()=> {
    const totalB = Math.max(1, Math.ceil(originalQuestions.length / QUESTIONS_PER_BATCH));
    if(batchIndex+1 < totalB) startBatch(batchIndex+1);
    else alert('No next batch available.');
  };
}

/* detailed review view */
function showDetailedReview(details){
  let html = `<h3>Detailed Review — Batch ${batchIndex+1}</h3><ol>`;
  details.forEach((d,i)=>{
    html += `<li style='margin:8px 0'><strong>${escapeHtml(d.q)}</strong><br>Your: ${d.ua !== null ? escapeHtml(d.options[d.ua]) : '<em>Not answered</em>'} ${d.isCorrect? '<span style="color:var(--good)"> (Correct)</span>' : '<span style="color:var(--bad)"> (Wrong)</span>' }<br>Correct: ${escapeHtml(d.options[d.correctIndex])}</li>`;
  });
  html += `</ol><div style="margin-top:12px"><button id='detailBack' class='primary'>Back to Menu</button></div>`;
  document.getElementById('result').innerHTML = html;
  document.getElementById('detailBack').onclick = ()=> { location.reload(); };
}

/* ----------------- IMPORT / EXPORT / UI ----------------- */
document.getElementById('exportBtn').onclick = ()=>{
  const data = JSON.stringify(originalQuestions, null, 2);
  const blob = new Blob([data],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'questions.json'; a.click(); URL.revokeObjectURL(url);
};

document.getElementById('importBtn').onclick = ()=>{ document.getElementById('importFile').click(); };
document.getElementById('importFile').onchange = (e)=>{
  const f = e.target.files[0]; if(!f) return; const reader = new FileReader(); reader.onload = ev=>{
    try{
      const arr = JSON.parse(ev.target.result);
      if(!Array.isArray(arr)) throw 0;
      originalQuestions = arr;
      alert('Imported '+arr.length+' questions.'); renderBatchMenu();
    }catch(err){ alert('Invalid JSON file'); }
  }; reader.readAsText(f);
};

/* Shuffle toggle */
document.getElementById('shuffleToggle').onclick = ()=>{ shuffleEnabled = !shuffleEnabled; document.getElementById('shuffleToggle').textContent = `Shuffle: ${shuffleEnabled? 'ON':'OFF'}`; saveState(); };
/* Dark toggle */
document.getElementById('darkToggle').onclick = ()=>{ darkMode = !darkMode; applyUISettings(); saveState(); };

/* ----------------- RESET ALL BATCHES ----------------- */
function resetAllBatches(){
  if (!confirm("Are you sure you want to reset all batches? This will clear completed status and saved progress.")) return;
  // Clear completed batches
  completedBatches = [];
  localStorage.setItem(COMPLETED_KEY, JSON.stringify(completedBatches));
  // Clear saved attempt state
  clearSavedState();
  // Re-render menu
  renderBatchMenu();
  alert("All batches and saved attempts have been reset.");
}

/* ----------------- UTIL ----------------- */
function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* update prev/next batch button visibility */
function updateBatchNavButtons(){
  const total = Math.max(1, Math.ceil(originalQuestions.length / QUESTIONS_PER_BATCH));
  document.getElementById('nextBatchBtn').disabled = (batchIndex+1 >= total);
  document.getElementById('prevBatchBtn').disabled = (batchIndex <= 0);
}

/* ----------------- INIT ----------------- */
renderBatchMenu();
applyUISettings();


let levelFilter = 'All';

function setLevelFilter(level) {
  levelFilter = level;
  startBatch(0);
}

const _origBuildBatches = buildBatches;
buildBatches = function () {
  let filtered = originalQuestions;
  if (levelFilter !== 'All') {
    filtered = originalQuestions.filter(q => q.level === levelFilter);
  }
  questions = shuffleEnabled ? shuffle([...filtered]) : [...filtered];
  batches = [];
  for (let i = 0; i < questions.length; i += QUESTIONS_PER_BATCH) {
    batches.push(questions.slice(i, i + QUESTIONS_PER_BATCH));
  }
};

</script>
</body>
</html>
